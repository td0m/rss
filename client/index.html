<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<meta name="theme-color" content="">
		<link rel="shortcut icon" href="">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="/style.css">
		<title>RSS</title>
	</head>
	<body class="container">
    <script type=module>
      import { add, h, state, derive, style } from 'https://tdom.dev/vanjs-starter.js'

      const $items = state([])

      const $filters = state({
        status: "unread"
      })

      function refetchItems() {
        fetch("/api/items?"+(new URLSearchParams($filters.val)).toString(), {
            headers: { 'content-type': 'application/json' },
          })
          .then(res => res.json())
          .then(items => $items.val = items)
          .catch(err => console.error(err))
      }
      refetchItems()

      style(`
        .item {
          display: flex;
          gap: 0.5rem;
          align-items: flex-start;
          padding-block: 0.1rem;
          .item__a {
            color: inherit;
            text-decoration: none;
            &:visited {
              color: #666;
            }
          }
          .item__links {
            display: flex;
            gap: 1rem;
          }
          .item__icon {
            padding: 0.15em;
            width: 1.5em;
            aspect-ratio: 1/1;
          }
          &[data-status=read] {
            .item__icon {
              filter: grayscale(100%);
            }
            .item__a {
              filter: grayscale(100%);
              text-decoration: line-through;
              color: #ccc;
            }
          }
        }
      `)
      const ItemLink = (item) => {
        let $title = state(item.title)
        let $expand = state(false)
        let timeout
        const onStart = (e) => {
          e.preventDefault()
          timeout = setTimeout(() => {
            clearTimeout(timeout)
            timeout = null
            // long
            console.log("LONG")
            $expand.val = true
          }, 500)
        }
        const onEnd = e => {
          clearTimeout(timeout)
          if (timeout) {
            // short
            window.open(item.link, '_blank').focus();
          }
        }
        return h.div(
          h.a({
              class: "item__a",
              // href: item.link,
              onmousedown: onStart,
              ontouchstart: onStart,
              onmouseup: onEnd,
              ontouchend: onEnd,
              target: "_blank"
            },
            () => $title.val,
          ),
          () => $expand.val ? h.div({ class: "item__actions" },
            item.links.map(link => h.a({href: link.url, target: "_blank"}, link.title)),
          ) : ""
        )
      }
      const Item = (item) => {
        const emojis = {
          "audio/mpeg": "ðŸ“»"
        }
        const ontoggle = async () => {
          const status = item.status === "unread" ? "read" : "unread"
          await fetch(`/api/items/${encodeURIComponent(item.id)}`, {
            method: "PATCH",
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({status})
          })
          $items.val = $items.val.map(it => {
            if (it.id === item.id) it.status = status
            return it
          })
          // refetchItems()
        }
        return h.li({ class: "item", "data-status": item.status },
          h.img({
            class: "item__icon",
            src: item.icon,
            onclick: ontoggle,
          }),
          ItemLink(item),
          // item.media.map(m => h.a({
          //     href: m.url,
          //   },
          //   emojis[m.type]
          // ))
        )
      }

      style(`
        .title {
          text-align: center;
        }
        .item-list {
          padding: 0;
          margin: 0;
        }
      `)

      const App = () => {
        return h.div(
          h.h2({ class: "title" }, "Feed"),
          () => $items.val.length === 0 ? h.p("You're all caught up! We'll refresh the feed for you at 8pm every day. Enjoy your day ;)") : "",
          () => h.ul({ class: "item-list" },
            $items.val.map(it => Item(it))
          )
        )
      }

      add(document.body, App())
    </script>
	</body>
</html>
